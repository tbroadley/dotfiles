#!/usr/bin/env bash
set -euo pipefail

# sandbox: Run Claude Code in an isolated container for safe planning/research
#
# - No host filesystem access
# - No credentials forwarded (except Anthropic API key for Claude Code to function)
# - Internet access for web searches
# - Claude Code runs with --dangerously-skip-permissions
#
# Usage: sandbox [options] [prompt...]
#   -r, --rebuild   Rebuild the sandbox Docker image

IMAGE_NAME="claude-sandbox"
REBUILD=false

while [[ "${1:-}" == -* ]]; do
    case "$1" in
        --rebuild|-r) REBUILD=true; shift ;;
        --) shift; break ;;
        *) break ;;
    esac
done

# Build image if needed
if [[ "$REBUILD" == true ]] || ! docker image inspect "$IMAGE_NAME" &>/dev/null; then
    echo "Building sandbox image..."
    docker build -t "$IMAGE_NAME" - <<'DOCKERFILE'
FROM node:lts-slim
RUN apt-get update -qq && \
    apt-get install -y -qq --no-install-recommends git curl ca-certificates && \
    rm -rf /var/lib/apt/lists/* && \
    npm install -g @anthropic-ai/claude-code
USER node
WORKDIR /home/node
RUN printf '#!/bin/sh\n\
mkdir -p /home/node/sandbox /home/node/.claude\n\
echo "$_CLAUDE_STATE" > /home/node/.claude.json\n\
echo "$_CLAUDE_SETTINGS" > /home/node/.claude/settings.json\n\
echo "$_CLAUDE_MD" > /home/node/sandbox/CLAUDE.md\n\
cd /home/node/sandbox\n\
git init -q\n\
exec claude --dangerously-skip-permissions "$@"\n' > /home/node/entrypoint.sh \
    && chmod +x /home/node/entrypoint.sh
ENTRYPOINT ["/home/node/entrypoint.sh"]
DOCKERFILE
    echo "Sandbox image built"
fi

# Get Anthropic API key (env var first, then macOS keychain)
api_key="${ANTHROPIC_API_KEY:-}"
if [[ -z "$api_key" ]] && command -v security &>/dev/null; then
    api_key=$(security find-generic-password -s "Claude Code" -w 2>/dev/null) || true
fi

if [[ -z "$api_key" ]]; then
    echo "Error: ANTHROPIC_API_KEY not found in environment or macOS keychain"
    exit 1
fi

# Pre-approve the API key and bypass permissions to skip interactive prompts
# Claude Code identifies keys by their last 20 characters
key_suffix="${api_key: -20}"
claude_state="{\"hasCompletedOnboarding\":true,\"theme\":\"dark\",\"bypassPermissionsModeAccepted\":true,\"effortCalloutDismissed\":true,\"customApiKeyResponses\":{\"approved\":[\"${key_suffix}\"]}}"

# Settings: use opus model
claude_settings='{"model":"opus"}'

# Project instructions
read -r -d '' claude_md << 'INSTRUCTIONS' || true
# Sandbox Planning Session

You are in an isolated sandbox container for research and planning. You have:

- **Full internet access** — use WebSearch and WebFetch liberally
- **No access to any codebase or file system** beyond this container
- **No credentials** — you cannot access private repos, APIs, or services

## Your Role

Help the user design and plan by:

1. **Researching thoroughly** — search the web, read documentation, explore options
2. **Comparing alternatives** — lay out trade-offs between approaches
3. **Producing concrete artifacts** — architecture docs, API designs, implementation plans
4. **Iterating on feedback** — refine plans based on the user's input

Do not hesitate to run many web searches. That is the whole point of this environment.
INSTRUCTIONS

exec docker run --rm -it \
    --name "claude-sandbox-$$" \
    --cap-drop=ALL \
    --security-opt=no-new-privileges \
    -e ANTHROPIC_API_KEY="$api_key" \
    -e ANTHROPIC_MODEL="${ANTHROPIC_MODEL:-}" \
    -e _CLAUDE_STATE="$claude_state" \
    -e _CLAUDE_SETTINGS="$claude_settings" \
    -e _CLAUDE_MD="$claude_md" \
    "$IMAGE_NAME" \
    "$@"
