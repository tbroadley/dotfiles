#!/bin/bash
# Opens a file or folder in Cursor on the host, attached to this dev container.
# Usage: cursor [file_or_directory]
# If no argument given, opens the current directory.

# If DEVCONTAINER_NAME is not set, fall back to Cursor's built-in remote CLI
if [ -z "$DEVCONTAINER_NAME" ]; then
    # Find Cursor's built-in CLI (excluding this script)
    THIS_SCRIPT=$(realpath "$0")
    for cursor_path in $(type -ap cursor); do
        cursor_real=$(realpath "$cursor_path" 2>/dev/null) || continue
        if [ "$cursor_real" != "$THIS_SCRIPT" ]; then
            exec "$cursor_path" "$@"
        fi
    done
    echo "Error: No cursor command available. DEVCONTAINER_NAME not set and Cursor CLI not found." >&2
    exit 1
fi

TARGET="${1:-.}"

if [ ! -e "$TARGET" ]; then
    echo "Error: $TARGET does not exist" >&2
    exit 1
fi

ABS_PATH=$(realpath "$TARGET")

# Determine if target is a file or directory
if [ -f "$TARGET" ]; then
    IS_FILE=1
else
    IS_FILE=0
fi

# Find and parse devcontainer.json for extensions
EXTENSIONS=""
for devcontainer_path in ".devcontainer/devcontainer.json" ".devcontainer.json"; do
    if [ -f "$devcontainer_path" ]; then
        EXTENSIONS=$(jq -r '.customizations.vscode.extensions // [] | join(",")' "$devcontainer_path" 2>/dev/null)
        break
    fi
done

PORT="${URL_LISTENER_PORT:-7077}"
ENCODED_NAME=$(printf '%s' "$DEVCONTAINER_NAME" | jq -sRr @uri)
ENCODED_PATH=$(printf '%s' "$ABS_PATH" | jq -sRr @uri)
ENCODED_EXTENSIONS=$(printf '%s' "$EXTENSIONS" | jq -sRr @uri)

curl -sf "http://host.docker.internal:${PORT}/cursor?container=${ENCODED_NAME}&path=${ENCODED_PATH}&file=${IS_FILE}&extensions=${ENCODED_EXTENSIONS}" >/dev/null 2>&1 &
