#!/bin/bash
# Opens files or a folder in Cursor on the host, attached to this dev container.
# Usage: cursor [file_or_directory...]
# If no argument given, opens the current directory.
# Multiple files can be specified to open them all in one Cursor window.

# If DEVCONTAINER_NAME is not set, fall back to Cursor's built-in remote CLI
if [ -z "$DEVCONTAINER_NAME" ]; then
    # Find Cursor's built-in CLI (excluding this script)
    THIS_SCRIPT=$(realpath "$0")
    for cursor_path in $(type -ap cursor); do
        cursor_real=$(realpath "$cursor_path" 2>/dev/null) || continue
        if [ "$cursor_real" != "$THIS_SCRIPT" ]; then
            exec "$cursor_path" "$@"
        fi
    done
    echo "Error: No cursor command available. DEVCONTAINER_NAME not set and Cursor CLI not found." >&2
    exit 1
fi

# Default to current directory if no arguments
if [ $# -eq 0 ]; then
    set -- "."
fi

# Validate all targets exist and determine if they're files or directories
IS_FILE=0
HAS_DIRECTORY=0
for TARGET in "$@"; do
    if [ ! -e "$TARGET" ]; then
        echo "Error: $TARGET does not exist" >&2
        exit 1
    fi
    if [ -d "$TARGET" ]; then
        HAS_DIRECTORY=1
    else
        IS_FILE=1
    fi
done

# Can't mix files and directories
if [ "$HAS_DIRECTORY" -eq 1 ] && [ "$IS_FILE" -eq 1 ]; then
    echo "Error: Cannot mix files and directories. Use only files or a single directory." >&2
    exit 1
fi

# Can only open one directory
if [ "$HAS_DIRECTORY" -eq 1 ] && [ $# -gt 1 ]; then
    echo "Error: Can only open one directory at a time." >&2
    exit 1
fi

# Find and parse devcontainer.json for extensions and settings
EXTENSIONS=""
SETTINGS=""
for devcontainer_path in ".devcontainer/devcontainer.json" ".devcontainer.json"; do
    if [ -f "$devcontainer_path" ]; then
        EXTENSIONS=$(jq -r '.customizations.vscode.extensions // [] | join(",")' "$devcontainer_path" 2>/dev/null)
        SETTINGS=$(jq -c '.customizations.vscode.settings // {}' "$devcontainer_path" 2>/dev/null)
        break
    fi
done

PORT="${URL_LISTENER_PORT:-7077}"
ENCODED_NAME=$(printf '%s' "$DEVCONTAINER_NAME" | jq -sRr @uri)
ENCODED_EXTENSIONS=$(printf '%s' "$EXTENSIONS" | jq -sRr @uri)
ENCODED_SETTINGS=$(printf '%s' "$SETTINGS" | jq -sRr @uri)
ENCODED_USER=$(printf '%s' "$(whoami)" | jq -sRr @uri)

# Build path parameters for all targets
PATH_PARAMS=""
for TARGET in "$@"; do
    ABS_PATH=$(realpath "$TARGET")
    ENCODED_PATH=$(printf '%s' "$ABS_PATH" | jq -sRr @uri)
    PATH_PARAMS="${PATH_PARAMS}&path=${ENCODED_PATH}"
done

curl -sf "http://host.docker.internal:${PORT}/cursor?container=${ENCODED_NAME}${PATH_PARAMS}&file=${IS_FILE}&extensions=${ENCODED_EXTENSIONS}&settings=${ENCODED_SETTINGS}&user=${ENCODED_USER}" >/dev/null 2>&1 &
